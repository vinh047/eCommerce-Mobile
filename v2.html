<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Điện thoại - Product List</title>
  <meta name="description" content="Danh sách điện thoại mới nhất: iPhone, Samsung, Oppo... Bộ lọc đầy đủ, giá tốt, giao nhanh.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: {
            primary: { DEFAULT: '#2563EB', hover: '#1D4ED8' },
            neutralC: { 900: '#111827', 600: '#6B7280', 200: '#E5E7EB', 50: '#F9FAFB' },
            success: '#16A34A', warning: '#F59E0B', danger: '#DC2626'
          },
          boxShadow: { subtle: '0 6px 18px rgba(17,24,39,0.08)' },
          borderRadius: { '2xl': '12px' }
        }
      }
    }
  </script>
  <style>
    .focus-ring:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,.35), 0 0 0 6px rgba(255,255,255,1); }
    .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .star { color: #F59E0B; }
  </style>
</head>
<body class="bg-neutralC-50 text-neutralC-900 font-sans">
  <!-- Live Toast -->
  <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] hidden">
    <div class="rounded-2xl bg-white border border-neutralC-200 shadow-subtle px-4 py-2 text-sm text-neutralC-900 flex items-center gap-2">
      <span id="toastIcon" class="w-5 h-5 rounded-full bg-primary text-white grid place-items-center">✓</span>
      <span id="toastText">Đã thêm vào giỏ</span>
    </div>
  </div>
  <!-- Live region for a11y -->
  <div id="liveRegion" class="sr-only" role="status" aria-live="polite"></div>

  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-neutralC-200">
    <div class="max-w-screen-2xl mx-auto px-4 md:px-6">
      <div class="flex items-center gap-4 py-3">
        <!-- Logo -->
        <a href="#" onclick="event.preventDefault()" class="flex items-center gap-2">
          <div class="w-9 h-9 rounded-2xl bg-primary text-white grid place-items-center shadow-subtle" aria-hidden="true">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="2" width="12" height="20" rx="3"/><circle cx="12" cy="18" r="1.2" fill="white"/></svg>
          </div>
          <span class="text-lg font-bold tracking-tight">MobileX</span>
        </a>

        <!-- Search -->
        <form id="searchForm" class="flex-1 hidden md:block" role="search" aria-label="Tìm kiếm">
          <label for="searchInput" class="sr-only">Tìm kiếm sản phẩm</label>
          <div class="relative">
            <input id="searchInput" name="q" aria-label="Tìm kiếm sản phẩm" placeholder="Tìm iPhone, Samsung, Oppo..."
                   class="w-full rounded-2xl border border-neutralC-200 bg-white pl-11 pr-4 py-2.5 placeholder:text-neutralC-600 focus-ring">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center text-neutralC-600">
              <svg width="18" height="18" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M21 21l-4.3-4.3m1.3-5.2a6.5 6.5 0 11-13 0 6.5 6.5 0 0113 0z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              </svg>
            </div>
          </div>
        </form>

        <div class="ml-auto flex items-center gap-1">
          <button id="errorDemoBtn" class="hidden md:inline-flex items-center gap-2 px-3 py-2 text-xs rounded-xl border border-neutralC-200 hover:bg-neutralC-50 focus-ring" title="Mô phỏng lỗi">Lỗi demo</button>
          <button class="p-2 rounded-xl hover:bg-neutralC-50 focus-ring" aria-label="Tài khoản">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" class="text-neutralC-900" aria-hidden="true">
              <path d="M12 12a5 5 0 100-10 5 5 0 000 10zM3 22a9 9 0 1118 0" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            </svg>
          </button>
          <div class="relative">
            <button id="cartBtn" class="relative p-2 rounded-xl hover:bg-neutralC-50 focus-ring" aria-label="Giỏ hàng">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" class="text-neutralC-900" aria-hidden="true">
                <path d="M6 6h14l-1.2 7H8.3L7 3H3" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                <circle cx="9" cy="20" r="1.5" fill="currentColor" />
                <circle cx="18" cy="20" r="1.5" fill="currentColor" />
              </svg>
              <span id="cartCount" class="absolute -top-1.5 -right-1.5 text-[10px] min-w-[18px] h-[18px] px-1 rounded-full bg-primary text-white grid place-items-center">0</span>
            </button>
            <!-- Mini Cart -->
            <div id="miniCart" class="hidden absolute right-0 mt-2 w-80 bg-white border border-neutralC-200 rounded-2xl shadow-subtle p-4">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-semibold">Giỏ hàng</h4>
                <button class="text-neutralC-600 hover:text-neutralC-900 text-sm" onclick="toggleMiniCart(false)">Đóng</button>
              </div>
              <div id="miniCartList" class="space-y-3 max-h-64 overflow-auto">
                <p class="text-neutralC-600 text-sm">Chưa có sản phẩm nào.</p>
              </div>
              <div class="mt-4 flex items-center justify-between">
                <span class="text-sm text-neutralC-600">Tạm tính</span>
                <span id="miniCartSubtotal" class="font-semibold">0₫</span>
              </div>
              <div class="mt-3 grid grid-cols-2 gap-2">
                <button class="px-3 py-2 rounded-xl border border-neutralC-200 hover:bg-neutralC-50 text-sm" onclick="toggleMiniCart(false)">Tiếp tục</button>
                <button class="px-3 py-2 rounded-xl bg-primary text-white hover:bg-primary-hover text-sm" onclick="showToast('Đây là mô phỏng thanh toán', true)">Thanh toán</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile search -->
      <form id="searchFormMobile" class="md:hidden pb-3" role="search" aria-label="Tìm kiếm">
        <label for="searchInputMobile" class="sr-only">Tìm kiếm sản phẩm</label>
        <div class="relative">
          <input id="searchInputMobile" name="q" aria-label="Tìm kiếm sản phẩm" placeholder="Tìm sản phẩm..."
                 class="w-full rounded-2xl border border-neutralC-200 bg-white pl-11 pr-4 py-2.5 placeholder:text-neutralC-600 focus-ring">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center text-neutralC-600">
            <svg width="18" height="18" fill="none" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M21 21l-4.3-4.3m1.3-5.2a6.5 6.5 0 11-13 0 6.5 6.5 0 0113 0z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            </svg>
          </div>
        </div>
      </form>
    </div>
  </header>

  <!-- Breadcrumb -->
  <nav class="max-w-screen-2xl mx-auto px-4 md:px-6 mt-4 text-sm text-neutralC-600" aria-label="Breadcrumb">
    <ol class="flex items-center gap-2">
      <li><a href="#" onclick="event.preventDefault()" class="hover:text-neutralC-900">Trang chủ</a></li>
      <li class="text-neutralC-600">/</li>
      <li aria-current="page" class="text-neutralC-900">Điện thoại</li>
    </ol>
  </nav>

  <!-- Main -->
  <main class="max-w-screen-2xl mx-auto px-4 md:px-6 py-6 md:py-8">
    <header class="flex items-start justify-between gap-4 mb-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">Điện thoại</h1>
        <p class="text-neutralC-600 mt-1 text-sm md:text-base">Khám phá các mẫu mới nhất với giá tốt và giao nhanh.</p>
      </div>
      <!-- Sort + Mobile Filter -->
      <div class="ml-auto flex items-center gap-2">
        <button id="mobileFilterBtn" class="md:hidden inline-flex items-center gap-2 px-3 py-2 rounded-2xl border border-neutralC-200 bg-white hover:bg-neutralC-50 focus-ring">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 7h18M6 12h12M9 17h6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
          Bộ lọc
        </button>
        <label class="sr-only" for="sortSelect">Sắp xếp</label>
        <select id="sortSelect" class="rounded-2xl border border-neutralC-200 bg-white px-3 py-2 text-sm focus-ring">
          <option value="newest">Mới nhất</option>
          <option value="price-asc">Giá ↑</option>
          <option value="price-desc">Giá ↓</option>
          <option value="rating-desc">Đánh giá cao</option>
        </select>
      </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-[18rem_1fr] gap-4 md:gap-6">
      <!-- Sidebar Filter (desktop) / Off-canvas (mobile) -->
      <aside id="filterAside" class="bg-white border border-neutralC-200 rounded-2xl p-4 md:sticky md:top-20 md:h-fit shadow-subtle md:shadow-none
                                     fixed inset-y-0 left-0 w-80 max-w-[88%] translate-x-[-110%] md:translate-x-0 transition-transform z-50 md:z-0">
        <!-- Mobile header -->
        <div class="flex items-center justify-between md:hidden mb-3">
          <h2 class="text-lg font-semibold">Bộ lọc</h2>
          <button id="filterCloseBtn" class="p-2 rounded-xl hover:bg-neutralC-50 focus-ring" aria-label="Đóng bộ lọc">✕</button>
        </div>

        <form id="filterForm" class="space-y-5" aria-label="Bộ lọc sản phẩm">
          <!-- Brand -->
          <fieldset class="border-t border-neutralC-200 pt-4 first:border-0 first:pt-0">
            <legend class="text-sm font-medium mb-2">Brand</legend>
            <div id="brandGroup" class="grid grid-cols-2 gap-2">
              <!-- Dynamic brand checkboxes -->
            </div>
          </fieldset>

          <!-- Price -->
          <fieldset class="border-t border-neutralC-200 pt-4">
            <legend class="text-sm font-medium mb-2">Giá (VND)</legend>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-neutralC-600" for="priceMin">Từ</label>
                <input id="priceMin" type="number" inputmode="numeric" placeholder="0" class="mt-1 w-full rounded-2xl border border-neutralC-200 px-3 py-2 focus-ring">
              </div>
              <div>
                <label class="text-xs text-neutralC-600" for="priceMax">Đến</label>
                <input id="priceMax" type="number" inputmode="numeric" placeholder="30000000" class="mt-1 w-full rounded-2xl border border-neutralC-200 px-3 py-2 focus-ring">
              </div>
            </div>
          </fieldset>

          <!-- RAM -->
          <fieldset class="border-t border-neutralC-200 pt-4">
            <legend class="text-sm font-medium mb-2">RAM</legend>
            <div class="flex flex-wrap gap-2">
              <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" value="6" class="rounded"> 6GB</label>
              <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" value="8" class="rounded"> 8GB</label>
              <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" value="12" class="rounded"> 12GB</label>
            </div>
          </fieldset>

          <!-- ROM -->
          <fieldset class="border-t border-neutralC-200 pt-4">
            <legend class="text-sm font-medium mb-2">ROM</legend>
            <div class="flex flex-wrap gap-2">
              <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" value="128" class="rounded"> 128GB</label>
              <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" value="256" class="rounded"> 256GB</label>
              <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" value="512" class="rounded"> 512GB</label>
            </div>
          </fieldset>

          <!-- 5G -->
          <fieldset class="border-t border-neutralC-200 pt-4">
            <legend class="text-sm font-medium mb-2">Kết nối</legend>
            <label class="inline-flex items-center gap-2 text-sm"><input id="has5g" type="checkbox" class="rounded"> Hỗ trợ 5G</label>
          </fieldset>

          <!-- Condition -->
          <fieldset class="border-t border-neutralC-200 pt-4">
            <legend class="text-sm font-medium mb-2">Tình trạng</legend>
            <div class="flex flex-wrap gap-2">
              <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" value="Mới" class="rounded"> Mới</label>
              <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" value="Cũ" class="rounded"> Cũ</label>
            </div>
          </fieldset>

          <div class="flex items-center gap-2 pt-2">
            <button type="button" id="clearFiltersBtn" class="flex-1 rounded-2xl border border-neutralC-200 px-4 py-2 hover:bg-neutralC-50 focus-ring">Xóa bộ lọc</button>
            <button type="button" id="applyFiltersBtn" class="md:hidden flex-1 rounded-2xl bg-primary text-white px-4 py-2 hover:bg-primary-hover focus-ring">Áp dụng</button>
          </div>
        </form>
      </aside>

      <!-- Content -->
      <section>
        <!-- Result bar -->
        <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
          <h2 class="text-lg font-semibold">Danh sách sản phẩm</h2>
          <div class="text-sm text-neutralC-600">Tìm thấy <span id="resultCount">0</span> sản phẩm</div>
        </div>

        <!-- Error state -->
        <div id="errorBox" class="hidden p-4 border border-danger/30 bg-red-50 rounded-2xl text-danger">
          <div class="flex items-start gap-3">
            <span class="mt-0.5">⚠️</span>
            <div class="flex-1">
              <p class="font-medium">Có lỗi xảy ra khi tải sản phẩm.</p>
              <p class="text-sm">Vui lòng thử lại sau giây lát.</p>
              <button id="retryBtn" class="mt-3 rounded-2xl border border-danger/30 px-4 py-2 text-danger hover:bg-white focus-ring">Thử lại</button>
            </div>
          </div>
        </div>

        <!-- Grid -->
        <div id="productGrid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6 mt-4" aria-busy="false" aria-live="polite">
          <!-- Cards injected here -->
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="hidden mt-6 rounded-2xl border border-neutralC-200 bg-white p-8 text-center">
          <div class="mx-auto w-12 h-12 rounded-full bg-neutralC-50 grid place-items-center mb-3">🔍</div>
          <h3 class="font-semibold">Không có sản phẩm</h3>
          <p class="text-neutralC-600 mt-1">Hãy thử bỏ bớt bộ lọc hoặc tìm từ khóa khác.</p>
          <button class="mt-4 rounded-2xl border border-neutralC-200 px-4 py-2 hover:bg-neutralC-50 focus-ring" id="clearFiltersBtn2">Xóa bộ lọc</button>
        </div>

        <!-- Pagination / Load more -->
        <div class="mt-6 flex items-center justify-center">
          <button id="loadMoreBtn" class="rounded-2xl border border-neutralC-200 bg-white px-4 py-2 hover:bg-neutralC-50 focus-ring">Xem thêm</button>
        </div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="mt-10 border-t border-neutralC-200">
    <div class="max-w-screen-2xl mx-auto px-4 md:px-6 py-8 text-sm text-neutralC-600 grid md:grid-cols-3 gap-6">
      <div>
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-2xl bg-primary text-white grid place-items-center">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="2" width="12" height="20" rx="3"/></svg>
          </div>
          <span class="font-semibold text-neutralC-900">MobileX</span>
        </div>
        <p class="mt-2">© 2025 MobileX. Học tập và mô phỏng UI.</p>
      </div>
      <div>
        <h3 class="font-semibold text-neutralC-900">Hỗ trợ</h3>
        <ul class="mt-2 space-y-1">
          <li><a href="#" onclick="event.preventDefault()" class="hover:text-neutralC-900">Chính sách bảo hành</a></li>
          <li><a href="#" onclick="event.preventDefault()" class="hover:text-neutralC-900">Đổi trả & hoàn tiền</a></li>
        </ul>
      </div>
      <div>
        <h3 class="font-semibold text-neutralC-900">Kết nối</h3>
        <ul class="mt-2 space-y-1">
          <li><a href="#" onclick="event.preventDefault()" class="hover:text-neutralC-900">Liên hệ</a></li>
          <li><a href="#" onclick="event.preventDefault()" class="hover:text-neutralC-900">Facebook</a></li>
        </ul>
      </div>
    </div>
  </footer>

  <!-- Buy Now Modal (demo) -->
  <div id="buyModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" onclick="toggleBuyModal(false)"></div>
    <div class="absolute inset-x-0 bottom-0 md:inset-0 md:grid md:place-items-center">
      <div class="md:max-w-lg w-full md:w-[520px] bg-white rounded-t-2xl md:rounded-2xl shadow-subtle border border-neutralC-200 p-5 md:p-6">
        <div class="flex items-start justify-between">
          <h3 class="text-lg font-semibold">Mua nhanh (demo)</h3>
          <button class="p-2 rounded-xl hover:bg-neutralC-50" onclick="toggleBuyModal(false)" aria-label="Đóng">✕</button>
        </div>
        <div class="mt-3 text-neutralC-900 space-y-1 text-sm">
          <div>Sản phẩm: <span id="buyName" class="font-medium"></span></div>
          <div>Phiên bản: <span id="buyVariant" class="font-medium"></span></div>
          <div>Giá: <span id="buyPrice" class="font-semibold text-primary"></span></div>
        </div>
        <div class="mt-5 grid grid-cols-2 gap-3">
          <button class="px-4 py-2 rounded-2xl border border-neutralC-200 hover:bg-neutralC-50 focus-ring" onclick="toggleBuyModal(false)">Tiếp tục</button>
          <button class="px-4 py-2 rounded-2xl bg-primary text-white hover:bg-primary-hover focus-ring" onclick="showToast('Đây là mô phỏng thanh toán', true)">Thanh toán (demo)</button>
        </div>
        <p class="mt-3 text-xs text-neutralC-600">Đây là mô phỏng trong Canva Code (không có thanh toán thật).</p>
      </div>
    </div>
  </div>

  <script>
    // --------- Data & State ----------
    const fmt = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 });

    const PRODUCTS = [
      { id: 'p1', name: 'iPhone 15', brand: 'Apple', ram: 6, rom: 128, g5: true, condition: 'Mới',
        priceOriginal: 27990000, priceSale: 23790000, rating: 4.6, reviews: 230, colors: ['#111827','#2563EB','#F472B6'], inStock: true, createdAt: '2025-07-10' },
      { id: 'p2', name: 'Samsung Galaxy S23', brand: 'Samsung', ram: 8, rom: 256, g5: true, condition: 'Mới',
        priceOriginal: 23990000, priceSale: 20990000, rating: 4.5, reviews: 180, colors: ['#0EA5E9','#111827'], inStock: true, createdAt: '2025-06-28' },
      { id: 'p3', name: 'Oppo Reno10', brand: 'Oppo', ram: 8, rom: 256, g5: true, condition: 'Mới',
        priceOriginal: 12990000, priceSale: 10990000, rating: 4.2, reviews: 95, colors: ['#10B981','#111827'], inStock: true, createdAt: '2025-05-19' },
      { id: 'p4', name: 'Xiaomi 13', brand: 'Xiaomi', ram: 12, rom: 256, g5: true, condition: 'Mới',
        priceOriginal: 15990000, priceSale: 13990000, rating: 4.4, reviews: 120, colors: ['#111827','#F59E0B'], inStock: true, createdAt: '2025-04-03' },
      { id: 'p5', name: 'OnePlus 11', brand: 'OnePlus', ram: 12, rom: 256, g5: true, condition: 'Mới',
        priceOriginal: 18990000, priceSale: 16990000, rating: 4.6, reviews: 150, colors: ['#111827','#22C55E'], inStock: false, createdAt: '2025-07-02' },
      { id: 'p6', name: 'Vivo V27', brand: 'Vivo', ram: 8, rom: 128, g5: true, condition: 'Mới',
        priceOriginal: 9990000, priceSale: 8990000, rating: 4.1, reviews: 70, colors: ['#2563EB','#111827'], inStock: true, createdAt: '2025-06-10' },
      { id: 'p7', name: 'Google Pixel 7', brand: 'Google', ram: 8, rom: 128, g5: true, condition: 'Cũ',
        priceOriginal: 14990000, priceSale: 11990000, rating: 4.7, reviews: 260, colors: ['#111827','#9CA3AF'], inStock: true, createdAt: '2025-03-18' },
      { id: 'p8', name: 'Realme 11 Pro', brand: 'Realme', ram: 8, rom: 256, g5: true, condition: 'Mới',
        priceOriginal: 10990000, priceSale: 9490000, rating: 4.0, reviews: 60, colors: ['#F59E0B','#111827'], inStock: true, createdAt: '2025-05-01' },
      { id: 'p9', name: 'Apple iPhone 14', brand: 'Apple', ram: 6, rom: 128, g5: true, condition: 'Cũ',
        priceOriginal: 19990000, priceSale: 16990000, rating: 4.5, reviews: 400, colors: ['#2563EB','#111827'], inStock: true, createdAt: '2025-02-01' },
      { id: 'p10', name: 'Samsung Galaxy A54', brand: 'Samsung', ram: 8, rom: 128, g5: true, condition: 'Mới',
        priceOriginal: 8990000, priceSale: 8290000, rating: 4.1, reviews: 80, colors: ['#111827','#22D3EE'], inStock: true, createdAt: '2025-06-15' }
    ];

    const state = {
      q: '',
      filters: { brands: new Set(), priceMin: null, priceMax: null, rams: new Set(), roms: new Set(), has5g: false, conditions: new Set() },
      sort: 'newest',
      perPage: 8,
      showCount: 8,
      cart: [],
      error: false
    };

    const $ = (s, p=document) => p.querySelector(s);
    const $$ = (s, p=document) => Array.from(p.querySelectorAll(s));

    // --------- Toast & Live Region ----------
    function showToast(text, ok=true) {
      const toast = $('#toast');
      $('#toastText').textContent = text;
      const icon = $('#toastIcon');
      icon.textContent = ok ? '✓' : '!';
      icon.className = 'w-5 h-5 rounded-full grid place-items-center ' + (ok ? 'bg-primary text-white' : 'bg-danger text-white');
      toast.classList.remove('hidden');
      clearTimeout(toast._t);
      toast._t = setTimeout(() => toast.classList.add('hidden'), 1800);
      // a11y live
      const live = $('#liveRegion');
      live.textContent = text;
    }

    // --------- Mini-cart ----------
    function toggleMiniCart(force) {
      const el = $('#miniCart');
      const show = typeof force === 'boolean' ? force : el.classList.contains('hidden');
      el.classList.toggle('hidden', !show);
    }
    function updateCartCount() {
      const count = state.cart.reduce((s, it) => s + it.qty, 0);
      $('#cartCount').textContent = count;
    }
    function updateMiniCart() {
      const list = $('#miniCartList');
      list.innerHTML = '';
      if (state.cart.length === 0) {
        list.innerHTML = '<p class="text-neutralC-600 text-sm">Chưa có sản phẩm nào.</p>';
      } else {
        state.cart.forEach((it, idx) => {
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between gap-3';
          row.innerHTML = `
            <div class="flex-1">
              <div class="text-sm font-medium">${it.name}</div>
              <div class="text-xs text-neutralC-600">SL: ${it.qty}</div>
            </div>
            <div class="text-sm font-semibold">${fmt.format(it.price * it.qty)}</div>
            <button class="text-neutralC-600 hover:text-danger" aria-label="Xóa">✕</button>
          `;
          row.querySelector('button').addEventListener('click', () => {
            state.cart.splice(idx,1);
            updateCartCount();
            updateMiniCart();
          });
          list.appendChild(row);
        });
      }
      const subtotal = state.cart.reduce((s, it) => s + it.price * it.qty, 0);
      $('#miniCartSubtotal').textContent = fmt.format(subtotal);
    }

    // --------- Filters / Sort / Search ----------
    function getBrands() {
      return Array.from(new Set(PRODUCTS.map(p => p.brand))).sort();
    }
    function hydrateBrandFilters() {
      const wrap = $('#brandGroup');
      wrap.innerHTML = '';
      getBrands().forEach(b => {
        const id = 'brand-' + b.toLowerCase().replace(/\s+/g,'-');
        const label = document.createElement('label');
        label.className = 'inline-flex items-center gap-2 text-sm';
        label.innerHTML = `<input id="${id}" type="checkbox" value="${b}" class="rounded"> ${b}`;
        label.querySelector('input').addEventListener('change', (e) => {
          if (e.target.checked) state.filters.brands.add(b); else state.filters.brands.delete(b);
          if (window.innerWidth >= 768) triggerSearch();
        });
        wrap.appendChild(label);
      });
    }

    function readNumeric(val) {
      const n = Number(val);
      return Number.isFinite(n) && n >= 0 ? n : null;
    }

    function applyFilters(data) {
      const f = state.filters;
      const q = state.q.toLowerCase().trim();
      return data.filter(p => {
        if (q && !(p.name.toLowerCase().includes(q) || p.brand.toLowerCase().includes(q))) return false;
        if (f.brands.size && !f.brands.has(p.brand)) return false;
        if (f.priceMin != null && p.priceSale < f.priceMin) return false;
        if (f.priceMax != null && p.priceSale > f.priceMax) return false;
        if (f.rams.size && !f.rams.has(String(p.ram))) return false;
        if (f.roms.size && !f.roms.has(String(p.rom))) return false;
        if (f.has5g && !p.g5) return false;
        if (f.conditions.size && !f.conditions.has(p.condition)) return false;
        return true;
      });
    }

    function sortProducts(list) {
      switch (state.sort) {
        case 'price-asc': return list.sort((a,b)=>a.priceSale-b.priceSale);
        case 'price-desc': return list.sort((a,b)=>b.priceSale-a.priceSale);
        case 'rating-desc': return list.sort((a,b)=>b.rating-a.rating || b.reviews-a.reviews);
        case 'newest':
        default: return list.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
      }
    }

    // --------- Render ----------
    function percentOff(p) {
      const off = Math.round((1 - p.priceSale / p.priceOriginal) * 100);
      return isFinite(off) ? off : 0;
    }

    function starBar(rating) {
      const pct = Math.max(0, Math.min(100, (rating/5)*100));
      return `
        <div class="relative inline-block align-middle" aria-label="Đánh giá ${rating}/5">
          <div class="flex" aria-hidden="true">
            ${'<span class="star">★</span>'.repeat(5)}
          </div>
          <div class="absolute inset-0 overflow-hidden" style="width:${100-pct}%;">
            <div class="flex text-neutralC-200">
              ${'<span>★</span>'.repeat(5)}
            </div>
          </div>
        </div>`;
    }

    function createCard(p) {
      const disabled = !p.inStock;
      const badge = disabled
        ? '<span class="ml-auto text-xs px-2 py-0.5 rounded-full bg-red-50 text-danger border border-danger/20">Hết hàng</span>'
        : '<span class="ml-auto text-xs px-2 py-0.5 rounded-full bg-green-50 text-success border border-green-200">Còn hàng</span>';

      const colors = (p.colors||[]).slice(0,4).map(c=>`<span class="w-4 h-4 rounded-full border border-neutralC-200" style="background:${c}"></span>`).join('');
      return `
        <article class="group rounded-2xl border border-neutralC-200 bg-white p-3 md:p-4 hover:shadow-subtle transition-colors">
          <a href="#product-${p.id}" class="block" onclick="event.preventDefault(); showToast('Mở chi tiết (demo)');">
            <figure class="aspect-square rounded-xl bg-neutralC-50 border border-neutralC-200 overflow-hidden grid place-items-center">
              <svg role="img" aria-label="${p.name} – ${p.brand}" viewBox="0 0 120 120" class="w-20 h-20">
                <rect x="40" y="10" width="40" height="100" rx="10" fill="#111827"></rect>
                <rect x="44" y="26" width="32" height="68" rx="8" fill="#0B1220"></rect>
              </svg>
            </figure>
          </a>
          <div class="mt-3 flex items-start gap-2">
            <h3 class="text-sm md:text-base font-medium line-clamp-2">${p.name}</h3>
            ${badge}
          </div>
          <div class="mt-2 flex items-center gap-2">
            <div class="text-primary font-semibold">${fmt.format(p.priceSale)}</div>
            <div class="text-neutralC-600 line-through text-sm">${fmt.format(p.priceOriginal)}</div>
            <span class="text-xs px-2 py-0.5 rounded-full bg-red-50 text-danger border border-danger/20">-${percentOff(p)}%</span>
          </div>
          <div class="mt-1 text-xs text-neutralC-600 flex items-center gap-2">
            <span class="inline-flex items-center gap-1">${starBar(p.rating)}</span>
            <span>${p.rating.toFixed(1)} • ${p.reviews}</span>
          </div>
          <div class="mt-2 flex items-center gap-1.5">${colors}</div>
          <div class="mt-3 grid grid-cols-2 gap-2">
            <button class="rounded-2xl bg-primary text-white px-3 py-2 text-sm font-semibold hover:bg-primary-hover focus-ring disabled:bg-neutralC-200 disabled:text-neutralC-600" ${disabled?'disabled':''}
                    onclick="openBuy('${p.id}')">Mua ngay</button>
            <button class="rounded-2xl border border-neutralC-200 bg-white px-3 py-2 text-sm font-semibold hover:bg-neutralC-50 focus-ring disabled:bg-neutralC-50 disabled:text-neutralC-600" ${disabled?'disabled':''}
                    onclick="addToCart('${p.id}')">Thêm giỏ</button>
          </div>
        </article>
      `;
    }

    function renderSkeleton(count=8) {
      const grid = $('#productGrid');
      grid.setAttribute('aria-busy','true');
      grid.innerHTML = '';
      for (let i=0;i<count;i++) {
        const card = document.createElement('div');
        card.className = 'rounded-2xl border border-neutralC-200 bg-white p-3 md:p-4 animate-pulse';
        card.innerHTML = `
          <div class="aspect-square rounded-xl bg-neutralC-50 border border-neutralC-200"></div>
          <div class="mt-3 h-4 bg-neutralC-200/60 rounded w-3/4"></div>
          <div class="mt-2 h-4 bg-neutralC-200/60 rounded w-1/2"></div>
          <div class="mt-2 h-4 bg-neutralC-200/60 rounded w-2/3"></div>
        `;
        grid.appendChild(card);
      }
    }

    function render(products) {
      const grid = $('#productGrid');
      const empty = $('#emptyState');
      const loadMore = $('#loadMoreBtn');

      if (state.error) {
        $('#errorBox').classList.remove('hidden');
        grid.innerHTML = '';
        empty.classList.add('hidden');
        loadMore.classList.add('hidden');
        grid.setAttribute('aria-busy','false');
        $('#resultCount').textContent = '0';
        return;
      } else {
        $('#errorBox').classList.add('hidden');
      }

      const filtered = applyFilters(products);
      const sorted = sortProducts(filtered);
      const total = sorted.length;
      $('#resultCount').textContent = total;

      if (total === 0) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
        loadMore.classList.add('hidden');
        grid.setAttribute('aria-busy','false');
        return;
      }
      empty.classList.add('hidden');

      const toShow = sorted.slice(0, state.showCount);
      grid.innerHTML = toShow.map(createCard).join('');

      loadMore.classList.toggle('hidden', state.showCount >= total);
      grid.setAttribute('aria-busy','false');
    }

    function triggerSearch(withSkeleton=true) {
      const grid = $('#productGrid');
      if (withSkeleton) {
        renderSkeleton(Math.min(state.perPage, 8));
        setTimeout(()=>render(PRODUCTS), 400);
      } else {
        render(PRODUCTS);
      }
    }

    // --------- CTA handlers ----------
    function addToCart(id) {
      const p = PRODUCTS.find(x=>x.id===id);
      if (!p || !p.inStock) return;
      const idx = state.cart.findIndex(it => it.id === id);
      if (idx >= 0) state.cart[idx].qty += 1;
      else state.cart.push({ id, name: p.name, price: p.priceSale, qty: 1 });
      updateCartCount();
      updateMiniCart();
      showToast(`Đã thêm ${p.name} vào giỏ`);
      toggleMiniCart(true);
    }

    function openBuy(id) {
      const p = PRODUCTS.find(x=>x.id===id);
      if (!p || !p.inStock) return;
      $('#buyName').textContent = p.name;
      $('#buyVariant').textContent = `${p.ram}GB RAM • ${p.rom}GB ROM`;
      $('#buyPrice').textContent = fmt.format(p.priceSale);
      toggleBuyModal(true);
    }

    function toggleBuyModal(show) {
      $('#buyModal').classList.toggle('hidden', !show);
    }

    // --------- Events ----------
    function bindEvents() {
      // Cart button
      $('#cartBtn').addEventListener('click', ()=> toggleMiniCart());
      document.addEventListener('click', (e)=>{
        const mc = $('#miniCart'); const btn = $('#cartBtn');
        if (!mc.contains(e.target) && !btn.contains(e.target)) mc.classList.add('hidden');
      });

      // Search
      $('#searchForm')?.addEventListener('submit', (e)=>{ e.preventDefault(); state.q = $('#searchInput').value||''; state.showCount = state.perPage; triggerSearch(); });
      $('#searchFormMobile')?.addEventListener('submit', (e)=>{ e.preventDefault(); state.q = $('#searchInputMobile').value||''; state.showCount = state.perPage; triggerSearch(); });

      // Sort
      $('#sortSelect').addEventListener('change', (e)=>{ state.sort = e.target.value; state.showCount = state.perPage; triggerSearch(); });

      // Filter fields
      $('#priceMin').addEventListener('change', (e)=>{ state.filters.priceMin = readNumeric(e.target.value); if (window.innerWidth>=768) triggerSearch(); });
      $('#priceMax').addEventListener('change', (e)=>{ state.filters.priceMax = readNumeric(e.target.value); if (window.innerWidth>=768) triggerSearch(); });
      // RAM
      $$('#filterAside fieldset:nth-of-type(3) input[type="checkbox"]').forEach(chk=>{
        chk.addEventListener('change', (e)=>{ const v = e.target.value; if (e.target.checked) state.filters.rams.add(v); else state.filters.rams.delete(v); if (window.innerWidth>=768) triggerSearch(); });
      });
      // ROM
      $$('#filterAside fieldset:nth-of-type(4) input[type="checkbox"]').forEach(chk=>{
        chk.addEventListener('change', (e)=>{ const v = e.target.value; if (e.target.checked) state.filters.roms.add(v); else state.filters.roms.delete(v); if (window.innerWidth>=768) triggerSearch(); });
      });
      // 5G
      $('#has5g').addEventListener('change', (e)=>{ state.filters.has5g = e.target.checked; if (window.innerWidth>=768) triggerSearch(); });
      // Condition
      $$('#filterAside fieldset:nth-of-type(6) input[type="checkbox"]').forEach(chk=>{
        chk.addEventListener('change', (e)=>{ const v = e.target.value; if (e.target.checked) state.filters.conditions.add(v); else state.filters.conditions.delete(v); if (window.innerWidth>=768) triggerSearch(); });
      });

      // Clear filters
      function clearFilters() {
        state.q = '';
        $('#searchInput') && ($('#searchInput').value = '');
        $('#searchInputMobile') && ($('#searchInputMobile').value = '');
        state.filters = { brands: new Set(), priceMin: null, priceMax: null, rams: new Set(), roms: new Set(), has5g: false, conditions: new Set() };
        // Uncheck all
        $$('#filterAside input[type="checkbox"]').forEach(i=> i.checked = false);
        $('#priceMin').value = ''; $('#priceMax').value = '';
        state.showCount = state.perPage;
        triggerSearch();
      }
      $('#clearFiltersBtn').addEventListener('click', clearFilters);
      $('#clearFiltersBtn2').addEventListener('click', clearFilters);

      // Apply (mobile)
      $('#applyFiltersBtn').addEventListener('click', ()=>{ toggleFilterPanel(false); triggerSearch(); });

      // Load more
      $('#loadMoreBtn').addEventListener('click', ()=>{
        renderSkeleton(4);
        setTimeout(()=>{ state.showCount += state.perPage; render(PRODUCTS); }, 400);
      });

      // Error demo
      $('#errorDemoBtn')?.addEventListener('click', ()=>{ state.error = true; render(PRODUCTS); });
      $('#retryBtn').addEventListener('click', ()=>{ state.error = false; triggerSearch(); });

      // Mobile filter panel handlers
      $('#mobileFilterBtn').addEventListener('click', ()=> toggleFilterPanel(true));
      $('#filterCloseBtn').addEventListener('click', ()=> toggleFilterPanel(false));
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') toggleFilterPanel(false); });
    }

    function toggleFilterPanel(show) {
      const aside = $('#filterAside');
      if (window.innerWidth >= 768) return; // desktop ignores
      aside.style.transform = show ? 'translateX(0%)' : 'translateX(-110%)';
      document.body.style.overflow = show ? 'hidden' : '';
    }

    // --------- Init ----------
    function init() {
      hydrateBrandFilters();
      // Brand checkbox handlers (after hydrate)
      $$('#brandGroup input[type="checkbox"]').forEach(chk=>{
        chk.addEventListener('change', (e)=>{ /* already handled while creating; keep for safety */ });
      });
      updateCartCount();
      updateMiniCart();
      triggerSearch(false);
    }

    document.addEventListener('DOMContentLoaded', () => {
      bindEvents();
      init();
    });
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98386970f4fefd70',t:'MTc1ODYxMzQxNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
