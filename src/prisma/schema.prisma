// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // postgresql://user:pass@host:5432/dbname
}

/**
 * ==========================
 * ENUMS
 * ==========================
 */
enum AccountStatus {
  active
  blocked
  deleted
}

enum CouponType {
  fixed
  percentage
}

enum OrderStatus {
  pending
  confirmed
  processing
  shipped
  delivered
  completed
  cancelled
  returned
  refunded
}

enum PaymentStatus {
  pending
  paid
  failed
}

enum InventoryTxnType {
  in
  out
  adjustment
  reservation
  release
}

enum DeviceStatus {
  in_stock
  sold
  reserved
  returned
  locked
}

enum PaymentTxnStatus {
  pending
  success
  failed
  refunded
}

enum RmaType {
  return
  exchange
  warranty
}

enum RmaStatus {
  pending
  approved
  rejected
  completed
  cancelled
}

enum ControlType {
  select
  multiselect
  bucket_select
}

enum DataType {
  string
  number
  boolean
  array
  bucket
  json
}

enum FacetType {
  discrete
  range
}

/**
 * ==========================
 * USERS & ADDRESS
 * ==========================
 */
model User {
  id           Int           @id @default(autoincrement())
  email        String        @unique @db.VarChar(255)
  passwordHash String        @map("password_hash") @db.VarChar(255)
  name         String?       @db.VarChar(255)
  avatar       String?       @db.VarChar(255)
  status       AccountStatus @default(active)
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamp(0)

  addresses Address[]
  cart      Cart?
  orders    Order[]
  reviews   Review[]

  @@index([email], map: "idx_users_email")
  @@map("users")
}

model Address {
  id        Int     @id @default(autoincrement())
  userId    Int     @map("user_id")
  line      String  @db.VarChar(255)
  phone     String? @db.VarChar(20)
  ward      String? @db.VarChar(100)
  district  String? @db.VarChar(100)
  province  String? @db.VarChar(100)
  isDefault Boolean @default(false) @map("is_default")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("address")
}

/**
 * ==========================
 * BRANDS, CATEGORIES, SPEC_TEMPLATES
 * ==========================
 */
model Brand {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(255)
  slug      String   @unique @db.VarChar(191)
  image     String?  @db.VarChar(255)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  products Product[]
  coupons  Coupon[]

  @@index([slug], map: "idx_brands_slug")
  @@map("brands")
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(255)
  slug      String   @unique @db.VarChar(191)
  parentId  Int?     @map("parent_id")
  isActive  Boolean  @default(true) @map("is_active")
  iconKey   String?  @map("icon_key") @db.VarChar(64)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  parent   Category?  @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryToCategory")

  products  Product[]
  templates SpecTemplate[]
  coupons   Coupon[]

  @@index([slug], map: "idx_categories_slug")
  @@index([parentId])
  @@map("categories")
}

// =================== SPEC TEMPLATE ===================
// ============== SPEC TEMPLATE ==============
model SpecTemplate {
  id         Int      @id @default(autoincrement())
  categoryId Int      @map("category_id")
  name       String   @db.VarChar(255)
  version    Int      @default(1)
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  // Relations
  category     Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  productSpecs ProductSpec[]
  variantSpecs VariantSpec[]

  @@index([categoryId, isActive])
  @@map("spec_templates")
}

// ============== SPEC DEFINITIONS ==============
model ProductSpec {
  id             Int         @id @default(autoincrement())
  specTemplateId Int         @map("spec_template_id")
  name           String      @db.VarChar(191)
  facetId        Int?        @map("facet_id")
  label          String      @db.VarChar(255)
  filterable     Boolean     @default(false)
  control        ControlType

  facet        Facet?             @relation(fields: [facetId], references: [id], onDelete: SetNull)
  specTemplate SpecTemplate       @relation(fields: [specTemplateId], references: [id], onDelete: Cascade)
  values       ProductSpecValue[]

  // Một ProductSpec có nhiều OptionSpec
  options OptionSpec[]

  @@index([facetId])
  @@index([specTemplateId])
  @@map("product_specs")
}

model VariantSpec {
  id             Int         @id @default(autoincrement())
  specTemplateId Int         @map("spec_template_id")
  name           String      @db.VarChar(191)
  facetId        Int?        @map("facet_id")
  label          String      @db.VarChar(255)
  filterable     Boolean     @default(false)
  control        ControlType

  facet        Facet?             @relation(fields: [facetId], references: [id], onDelete: SetNull)
  specTemplate SpecTemplate       @relation(fields: [specTemplateId], references: [id], onDelete: Cascade)
  values       VariantSpecValue[]

  // Một VariantSpec có nhiều OptionSpec
  options OptionSpec[]

  @@index([facetId])
  @@index([specTemplateId])
  @@map("variant_specs")
}

model OptionSpec {
  id        Int    @id @default(autoincrement())
  label     String @db.VarChar(255)
  value     String @db.VarChar(255)
  datatype       DataType


  productSpecId Int? @map("product_spec_id")
  variantSpecId Int? @map("variant_spec_id")

  // Mỗi OptionSpec thuộc về 1 ProductSpec hoặc 1 VariantSpec
  productSpec ProductSpec? @relation(fields: [productSpecId], references: [id], onDelete: Cascade)
  variantSpec VariantSpec? @relation(fields: [variantSpecId], references: [id], onDelete: Cascade)

  @@index([productSpecId])
  @@index([variantSpecId])
  @@map("option_specs")
}

// =================== FACET / BUCKET ===================
model Facet {
  id   Int       @id @default(autoincrement())
  type FacetType

  buckets      Bucket[]
  productSpecs ProductSpec[]
  variantSpecs VariantSpec[]

  @@map("facets")
}

model Bucket {
  id      Int    @id @default(autoincrement())
  facetId Int    @map("facet_id")
  gt      Float? @db.DoublePrecision
  lte     Float? @db.DoublePrecision
  label   String @db.VarChar(255)

  facet Facet @relation(fields: [facetId], references: [id], onDelete: Cascade)

  @@index([facetId])
  @@map("buckets")
}

// =================== PRODUCT / VARIANT ===================
model Product {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  slug        String   @unique @db.VarChar(191)
  brandId     Int      @map("brand_id")
  categoryId  Int      @map("category_id")
  description String?  @db.Text
  ratingAvg   Decimal  @default(0.00) @map("rating_avg") @db.Decimal(3, 2)
  ratingCount Int      @default(0) @map("rating_count")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  brand    Brand    @relation(fields: [brandId], references: [id])
  category Category @relation(fields: [categoryId], references: [id])

  variants          Variant[]
  productSpecValues ProductSpecValue[]
  Review            Review[]

  @@index([categoryId], map: "idx_products_category")
  @@index([brandId], map: "idx_products_brand")
  @@index([name])
  @@index([slug], map: "idx_products_slug")
  @@map("products")
}

model Variant {
  id        Int      @id @default(autoincrement())
  productId Int      @map("product_id")
  color     String?  @db.VarChar(100)
  price     Decimal  @db.Decimal(12, 2)
  stock     Int      @default(0)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  product              Product                @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantSpecValues    VariantSpecValue[]
  InventoryTransaction InventoryTransaction[]
  Device               Device[]
  CartItem             CartItem[]
  OrderItem            OrderItem[]
  Media                Media[]

  @@index([productId])
  @@index([price])
  @@map("variants")
}

// =================== SPEC VALUES (tách riêng Product/Variant) ===================
model ProductSpecValue {
  id        Int      @id @default(autoincrement())
  productId Int      @map("product_id")
  specKey   String   @map("spec_key") @db.VarChar(191) // thường map sang ProductSpec.name
  label     String?  @db.VarChar(255)
  valueJson Json     @map("value_json")
  type      DataType
  unit      String?  @db.VarChar(64)

  // cột phục vụ lọc/sort nhanh (tuỳ chọn, giữ để tương thích & hiệu năng)
  stringValue  String? @db.VarChar(255)
  numericValue Float?  @db.DoublePrecision

  product     Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  // optional: liên kết mềm tới ProductSpec qua specKey nếu cần đảm bảo toàn vẹn ở app layer
  ProductSpec ProductSpec[]

  @@index([productId])
  @@index([specKey])
  @@index([type])
  @@index([numericValue])
  @@map("product_spec_values")
}

model VariantSpecValue {
  id        Int      @id @default(autoincrement())
  variantId Int      @map("variant_id")
  specKey   String   @map("spec_key") @db.VarChar(191) // thường map sang VariantSpec.name
  label     String?  @db.VarChar(255)
  valueJson Json     @map("value_json")
  type      DataType
  unit      String?  @db.VarChar(64)

  // cột phục vụ lọc/sort nhanh (tuỳ chọn)
  stringValue  String? @db.VarChar(255)
  numericValue Float?  @db.DoublePrecision

  variant     Variant       @relation(fields: [variantId], references: [id], onDelete: Cascade)
  // optional: liên kết mềm tới VariantSpec qua specKey
  VariantSpec VariantSpec[]

  @@index([variantId])
  @@index([specKey])
  @@index([type])
  @@index([numericValue])
  @@map("variant_spec_values")
}

model Media {
  id        Int     @id @default(autoincrement())
  variantId Int     @map("variant_id")
  url       String  @db.VarChar(255)
  isPrimary Boolean @default(false) @map("is_primary")
  sortOrder Int     @default(0) @map("sort_order")

  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@map("media")
}

/**
 * ==========================
 * COUPONS & CARTS
 * ==========================
 */
model Coupon {
  id         Int           @id @default(autoincrement())
  code       String        @unique @db.VarChar(50)
  type       CouponType
  value      Decimal       @db.Decimal(12, 2)
  minOrder   Decimal       @default(0.00) @map("min_order") @db.Decimal(12, 2)
  startsAt   DateTime?     @map("starts_at") @db.Timestamp(0)
  endsAt     DateTime?     @map("ends_at") @db.Timestamp(0)
  usageLimit Int?          @map("usage_limit")
  used       Int           @default(0)
  status     AccountStatus @default(active)
  categoryId Int?          @map("category_id")
  brandId    Int?          @map("brand_id")

  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  brand    Brand?    @relation(fields: [brandId], references: [id], onDelete: SetNull)

  @@index([startsAt])
  @@index([endsAt])
  @@index([code], map: "idx_coupons_code")
  @@map("coupons")
}

model Cart {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique @map("user_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        Int @id @default(autoincrement())
  cartId    Int @map("cart_id")
  variantId Int @map("variant_id")
  quantity  Int

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant Variant @relation(fields: [variantId], references: [id])

  @@unique([cartId, variantId], map: "uniq_cart_variant")
  @@map("cart_items")
}

/**
 * ==========================
 * ORDERS & PAYMENTS
 * ==========================
 */
model Order {
  id               Int           @id @default(autoincrement())
  userId           Int           @map("user_id")
  code             String        @unique @db.VarChar(50)
  status           OrderStatus   @default(pending)
  paymentMethod    String?       @map("payment_method") @db.VarChar(50)
  paymentStatus    PaymentStatus @default(pending) @map("payment_status")
  discount         Decimal       @default(0.00) @db.Decimal(12, 2)
  shippingFee      Decimal       @default(0.00) @map("shipping_fee") @db.Decimal(12, 2)
  subtotal         Decimal       @db.Decimal(12, 2)
  total            Decimal       @db.Decimal(12, 2)
  addressSnapshot  Json?         @map("address_snapshot")
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamp(0)
  paidAt           DateTime?     @map("paid_at") @db.Timestamp(0)
  note             String?       @db.Text
  shippingProvider String?       @map("shipping_provider") @db.VarChar(100)
  shippingStatus   String?       @map("shipping_status") @db.VarChar(50)

  user         User                 @relation(fields: [userId], references: [id])
  items        OrderItem[]
  transactions PaymentTransaction[]
  rmas         Rma[]

  @@index([userId], map: "idx_orders_user")
  @@index([status], map: "idx_orders_status")
  @@index([createdAt], map: "idx_orders_created_at")
  @@map("orders")
}

model OrderItem {
  id           Int     @id @default(autoincrement())
  orderId      Int     @map("order_id")
  variantId    Int     @map("variant_id")
  price        Decimal @db.Decimal(12, 2)
  quantity     Int
  nameSnapshot String  @map("name_snapshot") @db.VarChar(255)

  order        Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant      Variant       @relation(fields: [variantId], references: [id])
  orderDevices OrderDevice[]
  rmas         Rma[]

  @@index([orderId])
  @@map("order_items")
}

model PaymentTransaction {
  id                Int              @id @default(autoincrement())
  orderId           Int              @map("order_id")
  provider          String?          @db.VarChar(100)
  providerPaymentId String?          @map("provider_payment_id") @db.VarChar(100)
  amount            Decimal          @db.Decimal(12, 2)
  status            PaymentTxnStatus @default(pending)
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamp(0)

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@map("payment_transactions")
}

/**
 * ==========================
 * REVIEWS & RMA
 * ==========================
 */
model Review {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  productId  Int      @map("product_id")
  stars      Int
  content    String?  @db.Text
  photosJson Json?    @map("photos_json")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  isActived  Boolean  @default(true) @map("is_actived")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId], map: "idx_reviews_product")
  @@index([userId], map: "idx_reviews_user")
  @@map("reviews")
}

model Rma {
  id           Int       @id @default(autoincrement())
  orderId      Int       @map("order_id")
  orderItemId  Int       @map("order_item_id")
  type         RmaType
  reason       String?   @db.Text
  status       RmaStatus @default(pending)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamp(0)
  evidenceJson Json?     @map("evidence_json")

  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@map("rmas")
}

/**
 * ==========================
 * STAFF & ROLES & PERMISSIONS
 * ==========================
 */
model Staff {
  id           Int           @id @default(autoincrement())
  email        String        @unique @db.VarChar(255)
  passwordHash String        @map("password_hash") @db.VarChar(255)
  name         String?       @db.VarChar(255)
  avatar       String?       @db.VarChar(255)
  status       AccountStatus @default(active)
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamp(0)

  staffRoles  StaffRole[]
  createdTxns InventoryTransaction[] @relation("TxnCreatedBy")

  @@map("staffs")
}

model Role {
  id        Int      @id @default(autoincrement())
  name      String   @unique @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  staffRoles      StaffRole[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model StaffRole {
  staffId    Int      @map("staff_id")
  roleId     Int      @map("role_id")
  assignedAt DateTime @default(now()) @map("assigned_at") @db.Timestamp(0)

  staff Staff @relation(fields: [staffId], references: [id], onDelete: Cascade)
  role  Role  @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([staffId, roleId])
  @@map("staff_roles")
}

model Permission {
  id          Int      @id @default(autoincrement())
  key         String   @unique @map("key") @db.VarChar(100)
  name        String   @db.VarChar(255)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       Int      @map("role_id")
  permissionId Int      @map("permission_id")
  grantedAt    DateTime @default(now()) @map("granted_at") @db.Timestamp(0)

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

/**
 * ==========================
 * INVENTORY & DEVICES
 * ==========================
 */
model InventoryTransaction {
  id            Int              @id @default(autoincrement())
  variantId     Int              @map("variant_id")
  type          InventoryTxnType
  quantity      Int
  reason        String?          @db.Text
  referenceJson Json?            @map("reference_json")
  createdBy     Int?             @map("created_by")
  createdAt     DateTime         @default(now()) @map("created_at") @db.Timestamp(0)

  variant Variant @relation(fields: [variantId], references: [id])
  staff   Staff?  @relation("TxnCreatedBy", fields: [createdBy], references: [id])

  @@map("inventory_transactions")
}

model Device {
  id        Int          @id @default(autoincrement())
  variantId Int          @map("variant_id")
  imei      String       @unique @db.VarChar(20)
  status    DeviceStatus @default(in_stock)
  createdAt DateTime     @default(now()) @map("created_at") @db.Timestamp(0)

  variant     Variant      @relation(fields: [variantId], references: [id], onDelete: Restrict)
  orderDevice OrderDevice?

  @@map("devices")
}

model OrderDevice {
  id          Int @id @default(autoincrement())
  orderItemId Int @map("order_item_id")
  deviceId    Int @unique @map("device_id")

  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  device    Device    @relation(fields: [deviceId], references: [id], onDelete: Restrict)

  @@map("order_devices")
}
